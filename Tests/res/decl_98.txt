syn_fn_def(
  name: fn_symbol(to_text),
  params: [
    (type: type_ref(type_symbol(any)), var: var(obj)),
    (type: type_ref(type_symbol(nat)), var: var(line_len))
  ],
  local_fns: [
    syn_fn_def(
      name: fn_symbol(wrap),
      params: [
        (type: type_ref(type_symbol(string)), var: var(str)),
        (type: type_ref(type_symbol(nat)), var: var(line_len))
      ],
      local_fns: [],
      expr: do_expr(
        [
          assignment_stmt(
            value: fn_call(
              name: fn_symbol(length),
              params: [const_or_var(str)],
              named_params: []
            ),
            var: var(len)
          ),
          assignment_stmt(
            value: fn_call(
              name: fn_symbol(match_idxs),
              params: [const_or_var(str)],
              named_params: []
            ),
            var: var(midxs)
          ),
          assignment_stmt(value: object(0), var: var(i)),
          assignment_stmt(
            value: tag_obj_expr(obj: seq_expr(head: []), tag: object(string)),
            var: var(wstr)
          ),
          assignment_stmt(value: object(0), var: var(ind_lev)),
          loop_stmt(
            cond: fn_call(
              name: op_symbol(lower),
              params: [const_or_var(i), const_or_var(len)],
              named_params: []
            ),
            body: [
              assignment_stmt(
                value: fn_call(
                  name: op_symbol(brackets),
                  params: [const_or_var(str), const_or_var(i)],
                  named_params: []
                ),
                var: var(ch)
              ),
              if_stmt(
                else: [
                  assignment_stmt(
                    value: fn_call(
                      name: op_symbol(minus),
                      params: [
                        fn_call(
                          name: op_symbol(minus),
                          params: [
                            fn_call(
                              name: op_symbol(brackets),
                              params: [const_or_var(midxs), const_or_var(i)],
                              named_params: []
                            ),
                            const_or_var(i)
                          ],
                          named_params: []
                        ),
                        object(1)
                      ],
                      named_params: []
                    ),
                    var: var(blk_len)
                  ),
                  if_stmt(
                    else: [
                      assignment_stmt(
                        value: fn_call(
                          name: op_symbol(plus),
                          params: [const_or_var(ind_lev), object(1)],
                          named_params: []
                        ),
                        var: var(ind_lev)
                      ),
                      assignment_stmt(
                        value: fn_call(
                          name: op_symbol(amp),
                          params: [
                            fn_call(
                              name: op_symbol(amp),
                              params: [
                                fn_call(
                                  name: op_symbol(amp),
                                  params: [
                                    const_or_var(wstr),
                                    fn_call(
                                      name: fn_symbol(string),
                                      params: [seq_expr(head: [const_or_var(ch)])],
                                      named_params: []
                                    )
                                  ],
                                  named_params: []
                                ),
                                tag_obj_expr(obj: seq_expr(head: [object(10)]), tag: object(string))
                              ],
                              named_params: []
                            ),
                            fn_call(
                              name: fn_symbol(rep_str),
                              params: [
                                fn_call(
                                  name: op_symbol(star),
                                  params: [object(2), const_or_var(ind_lev)],
                                  named_params: []
                                ),
                                const_or_var(ascii_space)
                              ],
                              named_params: []
                            )
                          ],
                          named_params: []
                        ),
                        var: var(wstr)
                      ),
                      assignment_stmt(
                        value: fn_call(
                          name: op_symbol(plus),
                          params: [const_or_var(i), object(1)],
                          named_params: []
                        ),
                        var: var(i)
                      )
                    ],
                    branches: [
                      (
                        cond: fn_call(
                          name: op_symbol(lower),
                          params: [const_or_var(blk_len), const_or_var(line_len)],
                          named_params: []
                        ),
                        body: [
                          assignment_stmt(
                            value: fn_call(
                              name: op_symbol(amp),
                              params: [
                                const_or_var(wstr),
                                fn_call(
                                  name: fn_symbol(substr),
                                  params: [
                                    const_or_var(str),
                                    const_or_var(i),
                                    fn_call(
                                      name: op_symbol(plus),
                                      params: [const_or_var(blk_len), object(2)],
                                      named_params: []
                                    )
                                  ],
                                  named_params: []
                                )
                              ],
                              named_params: []
                            ),
                            var: var(wstr)
                          ),
                          assignment_stmt(
                            value: fn_call(
                              name: op_symbol(plus),
                              params: [
                                fn_call(
                                  name: op_symbol(plus),
                                  params: [const_or_var(i), const_or_var(blk_len)],
                                  named_params: []
                                ),
                                object(2)
                              ],
                              named_params: []
                            ),
                            var: var(i)
                          )
                        ]
                      )
                    ]
                  )
                ],
                branches: [
                  (
                    cond: eq(left: const_or_var(ch), right: const_or_var(ascii_comma)),
                    body: [
                      assignment_stmt(
                        value: fn_call(
                          name: op_symbol(amp),
                          params: [
                            fn_call(
                              name: op_symbol(amp),
                              params: [
                                const_or_var(wstr),
                                tag_obj_expr(
                                  obj: seq_expr(head: [object(44), object(10)]),
                                  tag: object(string)
                                )
                              ],
                              named_params: []
                            ),
                            fn_call(
                              name: fn_symbol(rep_str),
                              params: [
                                fn_call(
                                  name: op_symbol(star),
                                  params: [object(2), const_or_var(ind_lev)],
                                  named_params: []
                                ),
                                const_or_var(ascii_space)
                              ],
                              named_params: []
                            )
                          ],
                          named_params: []
                        ),
                        var: var(wstr)
                      ),
                      loop_stmt(
                        cond: eq(
                          left: fn_call(
                            name: fn_symbol(at),
                            params: [const_or_var(str), const_or_var(i)],
                            named_params: []
                          ),
                          right: const_or_var(ascii_space)
                        ),
                        body: [
                          assignment_stmt(
                            value: fn_call(
                              name: op_symbol(plus),
                              params: [const_or_var(i), object(1)],
                              named_params: []
                            ),
                            var: var(i)
                          )
                        ],
                        skip_first: true
                      )
                    ]
                  ),
                  (
                    cond: fn_call(
                      name: fn_symbol(is_right_par),
                      params: [const_or_var(ch)],
                      named_params: []
                    ),
                    body: [
                      assert_stmt(
                        fn_call(
                          name: op_symbol(greater),
                          params: [const_or_var(ind_lev), object(0)],
                          named_params: []
                        )
                      ),
                      assignment_stmt(
                        value: fn_call(
                          name: op_symbol(minus),
                          params: [const_or_var(ind_lev), object(1)],
                          named_params: []
                        ),
                        var: var(ind_lev)
                      ),
                      assignment_stmt(
                        value: fn_call(
                          name: op_symbol(amp),
                          params: [
                            fn_call(
                              name: op_symbol(amp),
                              params: [
                                fn_call(
                                  name: op_symbol(amp),
                                  params: [
                                    const_or_var(wstr),
                                    tag_obj_expr(obj: seq_expr(head: [object(10)]), tag: object(string))
                                  ],
                                  named_params: []
                                ),
                                fn_call(
                                  name: fn_symbol(rep_str),
                                  params: [
                                    fn_call(
                                      name: op_symbol(star),
                                      params: [object(2), const_or_var(ind_lev)],
                                      named_params: []
                                    ),
                                    const_or_var(ascii_space)
                                  ],
                                  named_params: []
                                )
                              ],
                              named_params: []
                            ),
                            fn_call(
                              name: fn_symbol(string),
                              params: [seq_expr(head: [const_or_var(ch)])],
                              named_params: []
                            )
                          ],
                          named_params: []
                        ),
                        var: var(wstr)
                      ),
                      assignment_stmt(
                        value: fn_call(
                          name: op_symbol(plus),
                          params: [const_or_var(i), object(1)],
                          named_params: []
                        ),
                        var: var(i)
                      )
                    ]
                  ),
                  (
                    cond: eq(
                      left: fn_call(
                        name: op_symbol(brackets),
                        params: [const_or_var(midxs), const_or_var(i)],
                        named_params: []
                      ),
                      right: object(nil)
                    ),
                    body: [
                      assignment_stmt(
                        value: fn_call(
                          name: op_symbol(amp),
                          params: [
                            const_or_var(wstr),
                            fn_call(
                              name: fn_symbol(string),
                              params: [seq_expr(head: [const_or_var(ch)])],
                              named_params: []
                            )
                          ],
                          named_params: []
                        ),
                        var: var(wstr)
                      ),
                      assignment_stmt(
                        value: fn_call(
                          name: op_symbol(plus),
                          params: [const_or_var(i), object(1)],
                          named_params: []
                        ),
                        var: var(i)
                      )
                    ]
                  )
                ]
              )
            ],
            skip_first: false
          ),
          return_stmt(const_or_var(wstr))
        ]
      ),
      res_type: type_ref(type_symbol(string))
    ),
    syn_fn_def(
      name: fn_symbol(match_idxs),
      params: [(type: type_ref(type_symbol(string)), var: var(str))],
      local_fns: [],
      expr: do_expr(
        [
          assignment_stmt(
            value: fn_call(
              name: fn_symbol(length),
              params: [const_or_var(str)],
              named_params: []
            ),
            var: var(len)
          ),
          assignment_stmt(value: seq_expr(head: []), var: var(ms)),
          assignment_stmt(value: seq_expr(head: []), var: var(open_par_idxs)),
          for_stmt(
            body: [
              if_stmt(
                else: [
                  if_stmt(
                    else: [],
                    branches: [
                      (
                        cond: fn_call(
                          name: fn_symbol(is_right_par),
                          params: [const_or_var(ch)],
                          named_params: []
                        ),
                        body: [
                          assignment_stmt(
                            value: seq_expr(
                              head: [
                                fn_call(
                                  name: op_symbol(minus),
                                  params: [
                                    fn_call(
                                      name: op_symbol(minus),
                                      params: [const_or_var(len), const_or_var(i)],
                                      named_params: []
                                    ),
                                    object(1)
                                  ],
                                  named_params: []
                                )
                              ],
                              tail: const_or_var(open_par_idxs)
                            ),
                            var: var(open_par_idxs)
                          )
                        ]
                      )
                    ]
                  ),
                  assignment_stmt(value: object(nil), var: var(mtc))
                ],
                branches: [
                  (
                    cond: fn_call(
                      name: fn_symbol(is_left_par),
                      params: [const_or_var(ch)],
                      named_params: []
                    ),
                    body: [
                      assert_stmt(
                        neq(
                          left: const_or_var(open_par_idxs),
                          right: seq_expr(head: [])
                        )
                      ),
                      assignment_stmt(
                        value: fn_call(
                          name: op_symbol(brackets),
                          params: [const_or_var(open_par_idxs), object(0)],
                          named_params: []
                        ),
                        var: var(mtc)
                      ),
                      assignment_stmt(
                        value: fn_call(
                          name: fn_symbol(tail),
                          params: [const_or_var(open_par_idxs)],
                          named_params: []
                        ),
                        var: var(open_par_idxs)
                      )
                    ]
                  )
                ]
              ),
              assignment_stmt(
                value: seq_expr(head: [const_or_var(mtc)], tail: const_or_var(ms)),
                var: var(ms)
              )
            ],
            loops: [
              seq_iter(
                var: var(ch),
                values: fn_call(
                  name: fn_symbol(reverse),
                  params: [
                    fn_call(
                      name: fn_symbol(untag),
                      params: [const_or_var(str)],
                      named_params: []
                    )
                  ],
                  named_params: []
                ),
                idx_var: var(i)
              )
            ]
          ),
          return_stmt(const_or_var(ms))
        ]
      ),
      res_type: seq_type(
        nonempty: false,
        elem_type: union_type(
          {
            type_ref(type_symbol(nat)),
            symb_type(object(nil)),
            symb_type(object(end))
          }
        )
      )
    ),
    syn_fn_def(
      name: fn_symbol(is_left_par),
      params: [(type: type_ref(type_symbol(nat)), var: var(ch))],
      local_fns: [],
      expr: let_expr(
        expr: fn_call(
          name: fn_symbol(in),
          params: [const_or_var(ch), const_or_var(left_pars)],
          named_params: []
        ),
        stmts: [
          assignment_stmt(
            value: set_expr(
              {
                const_or_var(ascii_left_parenthesis),
                const_or_var(ascii_left_bracket),
                const_or_var(ascii_left_brace)
              }
            ),
            var: var(left_pars)
          )
        ]
      ),
      res_type: type_ref(type_symbol(bool))
    ),
    syn_fn_def(
      name: fn_symbol(is_right_par),
      params: [(type: type_ref(type_symbol(nat)), var: var(ch))],
      local_fns: [],
      expr: let_expr(
        expr: fn_call(
          name: fn_symbol(in),
          params: [const_or_var(ch), const_or_var(right_pars)],
          named_params: []
        ),
        stmts: [
          assignment_stmt(
            value: set_expr(
              {
                const_or_var(ascii_right_parenthesis),
                const_or_var(ascii_right_bracket),
                const_or_var(ascii_right_brace)
              }
            ),
            var: var(right_pars)
          )
        ]
      ),
      res_type: type_ref(type_symbol(bool))
    )
  ],
  expr: do_expr(
    [
      return_stmt(
        fn_call(
          name: fn_symbol(wrap),
          params: [
            fn_call(
              name: fn_symbol(to_text),
              params: [const_or_var(obj)],
              named_params: []
            ),
            const_or_var(line_len)
          ],
          named_params: []
        )
      )
    ]
  ),
  res_type: type_ref(type_symbol(string))
)
