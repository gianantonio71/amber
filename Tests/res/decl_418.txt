syn_fn_def(
  name: fn_symbol(wf_errors),
  params: [(type: type_ref(type_symbol(synprg)), var: var(prg))],
  local_fns: [],
  expr: do_expr(
    [
      assignment_stmt(
        value: fn_call(
          name: fn_symbol(set),
          params: [
            fn_call(
              name: fn_symbol(untag),
              params: [const_or_var(prg)],
              named_params: []
            )
          ],
          named_params: []
        ),
        var: var(decls)
      ),
      assignment_stmt(
        value: set_comp(
          sel_exprs: [],
          source: [
            in_clause(
              src: const_or_var(decls),
              ptrn: var_ptrn(
                name: var(d),
                ptrn: type_ptrn(type_ref(type_symbol(syntypedef)))
              )
            )
          ],
          expr: const_or_var(d)
        ),
        var: var(tdefs)
      ),
      assignment_stmt(
        value: set_comp(
          sel_exprs: [],
          source: [
            in_clause(
              src: const_or_var(decls),
              ptrn: var_ptrn(
                name: var(d),
                ptrn: type_ptrn(type_ref(type_symbol(synpartypedef)))
              )
            )
          ],
          expr: const_or_var(d)
        ),
        var: var(par_tdefs)
      ),
      assignment_stmt(
        value: set_comp(
          sel_exprs: [],
          source: [
            in_clause(
              src: const_or_var(decls),
              ptrn: var_ptrn(
                name: var(d),
                ptrn: type_ptrn(type_ref(type_symbol(synfndef)))
              )
            )
          ],
          expr: const_or_var(d)
        ),
        var: var(fndefs)
      ),
      assignment_stmt(
        value: set_comp(
          sel_exprs: [],
          source: [
            in_clause(
              src: const_or_var(decls),
              ptrn: var_ptrn(
                name: var(d),
                ptrn: type_ptrn(type_ref(type_symbol(synusingblock)))
              )
            )
          ],
          expr: const_or_var(d)
        ),
        var: var(ublocks)
      ),
      assignment_stmt(
        value: fn_call(
          name: op_symbol(amp),
          params: [
            set_comp(
              sel_exprs: [],
              source: [
                in_clause(src: const_or_var(fndefs), ptrn: var_ptrn(name: var(fd)))
              ],
              expr: fn_call(
                name: fn_symbol(untyped_sgn),
                params: [const_or_var(fd)],
                named_params: []
              )
            ),
            set_comp(
              sel_exprs: [],
              source: [
                in_clause(src: const_or_var(ublocks), ptrn: var_ptrn(name: var(ub))),
                in_clause(
                  src: fn_call(
                    name: fn_symbol(set),
                    params: [accessor(expr: const_or_var(ub), field: object(fn_defs))],
                    named_params: []
                  ),
                  ptrn: var_ptrn(name: var(fd))
                )
              ],
              expr: fn_call(
                name: fn_symbol(untyped_sgn),
                params: [
                  const_or_var(fd),
                  fn_call(
                    name: fn_symbol(set),
                    params: [
                      accessor(expr: const_or_var(ub), field: object(signatures))
                    ],
                    named_params: []
                  )
                ],
                named_params: []
              )
            )
          ],
          named_params: []
        ),
        var: var(all_def_fns)
      ),
      assignment_stmt(
        value: fn_call(
          name: fn_symbol(create_type_map),
          params: [const_or_var(prg)],
          named_params: []
        ),
        var: var(inst_tdefs)
      ),
      assignment_stmt(
        value: set_comp(
          sel_exprs: [
            and(
              left: neq(left: const_or_var(td1), right: const_or_var(td2)),
              right: eq(
                left: accessor(expr: const_or_var(td1), field: object(name)),
                right: accessor(expr: const_or_var(td2), field: object(name))
              )
            )
          ],
          source: [
            in_clause(src: const_or_var(tdefs), ptrn: var_ptrn(name: var(td1))),
            in_clause(src: const_or_var(tdefs), ptrn: var_ptrn(name: var(td2)))
          ],
          expr: tag_obj_expr(
            obj: accessor(expr: const_or_var(td1), field: object(name)),
            tag: object(dupl_tdef)
          )
        ),
        var: var(dup_tdef_errs)
      ),
      assignment_stmt(
        value: set_comp(
          sel_exprs: [
            and(
              left: and(
                left: neq(left: const_or_var(td1), right: const_or_var(td2)),
                right: eq(
                  left: accessor(expr: const_or_var(td1), field: object(name)),
                  right: accessor(expr: const_or_var(td2), field: object(name))
                )
              ),
              right: eq(
                left: fn_call(
                  name: fn_symbol(length),
                  params: [accessor(expr: const_or_var(td1), field: object(params))],
                  named_params: []
                ),
                right: fn_call(
                  name: fn_symbol(length),
                  params: [accessor(expr: const_or_var(td2), field: object(params))],
                  named_params: []
                )
              )
            )
          ],
          source: [
            in_clause(src: const_or_var(tdefs), ptrn: var_ptrn(name: var(td1))),
            in_clause(src: const_or_var(tdefs), ptrn: var_ptrn(name: var(td2)))
          ],
          expr: tag_obj_expr(
            obj: map_expr(
              {
                (
                  value: accessor(expr: const_or_var(td1), field: object(name)),
                  key: object(name)
                ),
                (
                  value: fn_call(
                    name: fn_symbol(length),
                    params: [accessor(expr: const_or_var(td1), field: object(params))],
                    named_params: []
                  ),
                  key: object(arity)
                )
              }
            ),
            tag: object(dupl_par_tdef)
          )
        ),
        var: var(dup_par_tdef_errs)
      ),
      assignment_stmt(
        value: fn_call(
          name: op_symbol(amp),
          params: [
            const_or_var(fndefs),
            fn_call(
              name: fn_symbol(union),
              params: [
                set_comp(
                  sel_exprs: [],
                  source: [
                    in_clause(src: const_or_var(ublocks), ptrn: var_ptrn(name: var(ub)))
                  ],
                  expr: fn_call(
                    name: fn_symbol(set),
                    params: [accessor(expr: const_or_var(ub), field: object(fn_defs))],
                    named_params: []
                  )
                )
              ],
              named_params: []
            )
          ],
          named_params: []
        ),
        var: var(all_fndefs)
      ),
      assignment_stmt(
        value: map_comp(
          sel_exprs: [],
          source: [
            in_clause(
              src: set_comp(
                sel_exprs: [],
                source: [
                  in_clause(
                    src: const_or_var(all_fndefs),
                    ptrn: var_ptrn(name: var(fd))
                  )
                ],
                expr: fn_call(
                  name: fn_symbol(untyped_sgn),
                  params: [const_or_var(fd)],
                  named_params: []
                )
              ),
              ptrn: var_ptrn(name: var(n))
            )
          ],
          value_expr: set_comp(
            sel_exprs: [
              eq(
                left: fn_call(
                  name: fn_symbol(untyped_sgn),
                  params: [const_or_var(fd)],
                  named_params: []
                ),
                right: const_or_var(n)
              )
            ],
            source: [
              in_clause(
                src: const_or_var(all_fndefs),
                ptrn: var_ptrn(name: var(fd))
              )
            ],
            expr: const_or_var(fd)
          ),
          key_expr: const_or_var(n)
        ),
        var: var(fn_groups)
      ),
      assignment_stmt(
        value: set_comp(
          sel_exprs: [
            neq(left: const_or_var(fd1), right: const_or_var(fd2)),
            not(
              fn_call(
                name: fn_symbol(syn_fns_are_compatible),
                params: [const_or_var(fd1), const_or_var(fd2)],
                named_params: [
                  syn_fn_def(
                    name: fn_symbol(typedefs),
                    params: [],
                    local_fns: [],
                    expr: const_or_var(inst_tdefs)
                  )
                ]
              )
            )
          ],
          source: [
            map_in_clause(
              src: const_or_var(fn_groups),
              value_ptrn: var_ptrn(name: var(fns)),
              key_ptrn: var_ptrn(name: var(s))
            ),
            in_clause(src: const_or_var(fns), ptrn: var_ptrn(name: var(fd1))),
            in_clause(src: const_or_var(fns), ptrn: var_ptrn(name: var(fd2)))
          ],
          expr: tag_obj_expr(
            obj: map_expr(
              {
                (
                  value: accessor(expr: const_or_var(s), field: object(name)),
                  key: object(name)
                ),
                (
                  value: accessor(expr: const_or_var(s), field: object(arity)),
                  key: object(arity)
                ),
                (
                  value: set_comp(
                    sel_exprs: [],
                    source: [
                      in_clause(
                        src: set_expr({const_or_var(fd1), const_or_var(fd2)}),
                        ptrn: var_ptrn(name: var(fd))
                      )
                    ],
                    expr: fn_call(
                      name: fn_symbol(par_parts),
                      params: [const_or_var(fd)],
                      named_params: [
                        syn_fn_def(
                          name: fn_symbol(typedefs),
                          params: [],
                          local_fns: [],
                          expr: const_or_var(inst_tdefs)
                        )
                      ]
                    )
                  ),
                  key: object(params)
                )
              }
            ),
            tag: object(incomp_fndefs)
          )
        ),
        var: var(incomp_fn_sgns)
      ),
      assignment_stmt(
        value: fn_call(
          name: fn_symbol(undef_type_symbol_errs),
          params: [const_or_var(fndefs), const_or_var(ublocks)],
          named_params: [
            syn_fn_def(
              name: fn_symbol(typedefs),
              params: [],
              local_fns: [],
              expr: const_or_var(inst_tdefs)
            )
          ]
        ),
        var: var(undef_type_symb_errs)
      ),
      assignment_stmt(
        value: fn_call(
          name: op_symbol(amp),
          params: [
            fn_call(
              name: op_symbol(amp),
              params: [
                fn_call(
                  name: op_symbol(amp),
                  params: [
                    const_or_var(dup_tdef_errs),
                    const_or_var(dup_par_tdef_errs)
                  ],
                  named_params: []
                ),
                const_or_var(incomp_fn_sgns)
              ],
              named_params: []
            ),
            const_or_var(undef_type_symb_errs)
          ],
          named_params: []
        ),
        var: var(errs_so_far)
      ),
      if_stmt(
        else: [],
        branches: [
          (
            cond: neq(left: const_or_var(errs_so_far), right: set_expr({})),
            body: [return_stmt(const_or_var(errs_so_far))]
          )
        ]
      ),
      let_stmt(
        body: [
          assignment_stmt(
            value: fn_call(
              name: op_symbol(amp),
              params: [
                fn_call(
                  name: op_symbol(amp),
                  params: [
                    fn_call(
                      name: op_symbol(amp),
                      params: [
                        fn_call(
                          name: op_symbol(amp),
                          params: [
                            fn_call(
                              name: fn_symbol(tdef_errs),
                              params: [const_or_var(tdefs)],
                              named_params: []
                            ),
                            fn_call(
                              name: fn_symbol(par_tdef_errs),
                              params: [const_or_var(par_tdefs)],
                              named_params: []
                            )
                          ],
                          named_params: []
                        ),
                        fn_call(
                          name: fn_symbol(inst_tdef_errs),
                          params: [const_or_var(inst_tdefs)],
                          named_params: []
                        )
                      ],
                      named_params: []
                    ),
                    fn_call(
                      name: fn_symbol(fn_def_errs),
                      params: [
                        const_or_var(fndefs),
                        const_or_var(all_def_fns),
                        set_expr({})
                      ],
                      named_params: []
                    )
                  ],
                  named_params: []
                ),
                fn_call(
                  name: fn_symbol(ublock_errors),
                  params: [const_or_var(ublocks), const_or_var(all_def_fns)],
                  named_params: []
                )
              ],
              named_params: []
            ),
            var: var(decl_errs)
          )
        ],
        asgnms: [
          syn_fn_def(
            name: fn_symbol(fns_in_scope),
            params: [],
            local_fns: [],
            expr: const_or_var(all_def_fns)
          ),
          syn_fn_def(
            name: fn_symbol(typedefs),
            params: [],
            local_fns: [],
            expr: const_or_var(inst_tdefs)
          ),
          syn_fn_def(
            name: fn_symbol(all_par_type_symbols),
            params: [],
            local_fns: [],
            expr: set_comp(
              sel_exprs: [],
              source: [
                in_clause(src: const_or_var(par_tdefs), ptrn: var_ptrn(name: var(p)))
              ],
              expr: seq_expr(
                head: [
                  accessor(expr: const_or_var(p), field: object(name)),
                  fn_call(
                    name: fn_symbol(length),
                    params: [accessor(expr: const_or_var(p), field: object(params))],
                    named_params: []
                  )
                ]
              )
            )
          )
        ]
      ),
      return_stmt(const_or_var(decl_errs))
    ]
  ),
  res_type: set_type(nonempty: false, elem_type: type_ref(type_symbol(usererr)))
)
