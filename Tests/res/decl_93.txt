using_block(
  fn_defs: [
    syn_fn_def(
      name: fn_symbol(select_expr_fn),
      params: [(type: type_ref(type_symbol(any)), var: var(obj))],
      local_fns: [],
      expr: do_expr(
        [
          if_stmt(
            else: [],
            branches: [
              (
                cond: fn_call(
                  name: fn_symbol(condition),
                  params: [const_or_var(obj)],
                  named_params: []
                ),
                body: [
                  return_stmt(
                    set_expr(
                      {
                        fn_call(
                          name: fn_symbol(eval),
                          params: [const_or_var(obj)],
                          named_params: []
                        )
                      }
                    )
                  )
                ]
              )
            ]
          ),
          return_stmt(
            match_expr(
              cases: [
                case(
                  expr: set_expr({}),
                  patterns: [type_ptrn(type_ref(type_symbol(atom)))]
                ),
                case(
                  expr: set_expr({}),
                  patterns: [type_ptrn(type_ref(type_symbol(int)))]
                ),
                case(
                  expr: fn_call(
                    name: fn_symbol(union),
                    params: [
                      set_comp(
                        sel_exprs: [],
                        source: [
                          in_clause(src: const_or_var(obj), ptrn: var_ptrn(name: var(x)))
                        ],
                        expr: fn_call(
                          name: fn_symbol(select_expr_fn),
                          params: [const_or_var(x)],
                          named_params: []
                        )
                      )
                    ],
                    named_params: []
                  ),
                  patterns: [type_ptrn(type_ref(type_symbol(set)))]
                ),
                case(
                  expr: fn_call(
                    name: fn_symbol(union),
                    params: [
                      set_comp(
                        sel_exprs: [],
                        source: [
                          in_clause(
                            src: fn_call(
                              name: fn_symbol(set),
                              params: [const_or_var(obj)],
                              named_params: []
                            ),
                            ptrn: var_ptrn(name: var(x))
                          )
                        ],
                        expr: fn_call(
                          name: fn_symbol(select_expr_fn),
                          params: [const_or_var(x)],
                          named_params: []
                        )
                      )
                    ],
                    named_params: []
                  ),
                  patterns: [type_ptrn(type_ref(type_symbol(seq)))]
                ),
                case(
                  expr: fn_call(
                    name: fn_symbol(union),
                    params: [
                      set_comp(
                        sel_exprs: [],
                        source: [
                          map_in_clause(
                            src: const_or_var(obj),
                            value_ptrn: var_ptrn(name: var(v)),
                            key_ptrn: var_ptrn(name: var(k))
                          )
                        ],
                        expr: fn_call(
                          name: op_symbol(amp),
                          params: [
                            fn_call(
                              name: fn_symbol(select_expr_fn),
                              params: [const_or_var(k)],
                              named_params: []
                            ),
                            fn_call(
                              name: fn_symbol(select_expr_fn),
                              params: [const_or_var(v)],
                              named_params: []
                            )
                          ],
                          named_params: []
                        )
                      )
                    ],
                    named_params: []
                  ),
                  patterns: [type_ptrn(type_ref(type_symbol(map)))]
                ),
                case(
                  expr: fn_call(
                    name: fn_symbol(select_expr_fn),
                    params: [const_or_var(iobj)],
                    named_params: []
                  ),
                  patterns: [
                    tag_ptrn(
                      obj: var_ptrn(name: var(iobj)),
                      tag: var_ptrn(name: var(tag))
                    )
                  ]
                )
              ],
              exprs: [const_or_var(obj)]
            )
          )
        ]
      ),
      res_type: set_type(nonempty: false, elem_type: type_ref(type_symbol(any)))
    ),
    syn_fn_def(
      name: fn_symbol(replace_expr_fn),
      params: [(type: type_ref(type_symbol(any)), var: var(obj))],
      local_fns: [],
      expr: do_expr(
        [
          if_stmt(
            else: [],
            branches: [
              (
                cond: fn_call(
                  name: fn_symbol(condition),
                  params: [const_or_var(obj)],
                  named_params: []
                ),
                body: [
                  return_stmt(
                    fn_call(
                      name: fn_symbol(eval),
                      params: [const_or_var(obj)],
                      named_params: []
                    )
                  )
                ]
              )
            ]
          ),
          return_stmt(
            match_expr(
              cases: [
                case(
                  expr: const_or_var(obj),
                  patterns: [type_ptrn(type_ref(type_symbol(atom)))]
                ),
                case(
                  expr: const_or_var(obj),
                  patterns: [type_ptrn(type_ref(type_symbol(int)))]
                ),
                case(
                  expr: set_comp(
                    sel_exprs: [],
                    source: [
                      in_clause(src: const_or_var(obj), ptrn: var_ptrn(name: var(x)))
                    ],
                    expr: fn_call(
                      name: fn_symbol(replace_expr_fn),
                      params: [const_or_var(x)],
                      named_params: []
                    )
                  ),
                  patterns: [type_ptrn(type_ref(type_symbol(set)))]
                ),
                case(
                  expr: seq_comp(
                    var: var(x),
                    expr: fn_call(
                      name: fn_symbol(replace_expr_fn),
                      params: [const_or_var(x)],
                      named_params: []
                    ),
                    src_expr: const_or_var(obj)
                  ),
                  patterns: [type_ptrn(type_ref(type_symbol(seq)))]
                ),
                case(
                  expr: map_comp(
                    sel_exprs: [],
                    source: [
                      map_in_clause(
                        src: const_or_var(obj),
                        value_ptrn: var_ptrn(name: var(v)),
                        key_ptrn: var_ptrn(name: var(k))
                      )
                    ],
                    value_expr: fn_call(
                      name: fn_symbol(replace_expr_fn),
                      params: [const_or_var(v)],
                      named_params: []
                    ),
                    key_expr: fn_call(
                      name: fn_symbol(replace_expr_fn),
                      params: [const_or_var(k)],
                      named_params: []
                    )
                  ),
                  patterns: [type_ptrn(type_ref(type_symbol(map)))]
                ),
                case(
                  expr: tag_obj_expr(
                    obj: fn_call(
                      name: fn_symbol(replace_expr_fn),
                      params: [const_or_var(iobj)],
                      named_params: []
                    ),
                    tag: const_or_var(tag)
                  ),
                  patterns: [
                    tag_ptrn(
                      obj: var_ptrn(name: var(iobj)),
                      tag: var_ptrn(name: var(tag))
                    )
                  ]
                )
              ],
              exprs: [const_or_var(obj)]
            )
          )
        ]
      ),
      res_type: type_ref(type_symbol(any))
    )
  ],
  signatures: [
    syn_sgn(
      name: fn_symbol(condition),
      params: [type_ref(type_symbol(any))],
      res_type: type_ref(type_symbol(bool))
    ),
    syn_sgn(
      name: fn_symbol(eval),
      params: [type_ref(type_symbol(any))],
      res_type: type_ref(type_symbol(any))
    )
  ]
)
