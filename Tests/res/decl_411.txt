syn_fn_def(
  name: fn_symbol(inst_req_par_types),
  params: [(type: type_ref(type_symbol(synprg)), var: var(prg))],
  local_fns: [],
  expr: do_expr(
    [
      assignment_stmt(
        value: fn_call(
          name: fn_symbol(set),
          params: [
            fn_call(
              name: fn_symbol(untag),
              params: [const_or_var(prg)],
              named_params: []
            )
          ],
          named_params: []
        ),
        var: var(decls)
      ),
      assignment_stmt(
        value: set_comp(
          sel_exprs: [],
          source: [
            in_clause(
              src: const_or_var(decls),
              ptrn: var_ptrn(
                name: var(d),
                ptrn: type_ptrn(type_ref(type_symbol(syntypedef)))
              )
            )
          ],
          expr: const_or_var(d)
        ),
        var: var(tdefs)
      ),
      assignment_stmt(
        value: set_comp(
          sel_exprs: [],
          source: [
            in_clause(
              src: const_or_var(decls),
              ptrn: var_ptrn(
                name: var(d),
                ptrn: type_ptrn(type_ref(type_symbol(synpartypedef)))
              )
            )
          ],
          expr: const_or_var(d)
        ),
        var: var(par_tdefs)
      ),
      assignment_stmt(
        value: set_comp(
          sel_exprs: [],
          source: [
            in_clause(
              src: const_or_var(decls),
              ptrn: var_ptrn(
                name: var(d),
                ptrn: type_ptrn(type_ref(type_symbol(synfndef)))
              )
            )
          ],
          expr: const_or_var(d)
        ),
        var: var(fndefs)
      ),
      assignment_stmt(
        value: set_comp(
          sel_exprs: [],
          source: [
            in_clause(
              src: const_or_var(decls),
              ptrn: var_ptrn(
                name: var(d),
                ptrn: type_ptrn(type_ref(type_symbol(synusingblock)))
              )
            )
          ],
          expr: const_or_var(d)
        ),
        var: var(ublocks)
      ),
      assignment_stmt(
        value: fn_call(
          name: fn_symbol(get_type_symbols_to_instantiate),
          params: [
            fn_call(
              name: op_symbol(amp),
              params: [
                fn_call(
                  name: op_symbol(amp),
                  params: [const_or_var(fndefs), const_or_var(ublocks)],
                  named_params: []
                ),
                const_or_var(tdefs)
              ],
              named_params: []
            )
          ],
          named_params: []
        ),
        var: var(symbs_to_inst)
      ),
      assignment_stmt(value: set_expr({}), var: var(inst_symbs_so_far)),
      assignment_stmt(value: map_expr({}), var: var(inst_par_tdefs)),
      loop_stmt(
        cond: neq(left: const_or_var(symbs_to_inst), right: set_expr({})),
        body: [
          assignment_stmt(
            value: map_comp(
              sel_exprs: [],
              source: [
                in_clause(
                  src: const_or_var(symbs_to_inst),
                  ptrn: var_ptrn(name: var(s))
                )
              ],
              value_expr: fn_call(
                name: fn_symbol(inst_par_type),
                params: [const_or_var(s), const_or_var(par_tdefs)],
                named_params: []
              ),
              key_expr: const_or_var(s)
            ),
            var: var(new_insts)
          ),
          assignment_stmt(
            value: fn_call(
              name: op_symbol(amp),
              params: [
                const_or_var(inst_symbs_so_far),
                const_or_var(symbs_to_inst)
              ],
              named_params: []
            ),
            var: var(inst_symbs_so_far)
          ),
          assignment_stmt(
            value: fn_call(
              name: op_symbol(amp),
              params: [const_or_var(inst_par_tdefs), const_or_var(new_insts)],
              named_params: []
            ),
            var: var(inst_par_tdefs)
          ),
          assignment_stmt(
            value: fn_call(
              name: op_symbol(minus),
              params: [
                fn_call(
                  name: fn_symbol(get_type_symbols_to_instantiate),
                  params: [
                    set_comp(
                      sel_exprs: [],
                      source: [
                        map_in_clause(
                          src: const_or_var(new_insts),
                          value_ptrn: var_ptrn(name: var(t)),
                          key_ptrn: var_ptrn(name: var(s))
                        )
                      ],
                      expr: const_or_var(t)
                    )
                  ],
                  named_params: []
                ),
                const_or_var(inst_symbs_so_far)
              ],
              named_params: []
            ),
            var: var(symbs_to_inst)
          )
        ],
        skip_first: false
      ),
      return_stmt(const_or_var(inst_par_tdefs))
    ]
  ),
  res_type: map_type(
    value_type: type_ref(type_symbol(syntype)),
    key_type: type_ref(type_symbol(partypesymbol))
  )
)
