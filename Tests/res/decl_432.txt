syn_fn_def(
  name: fn_symbol(rem_syntax),
  params: [(type: type_ref(type_symbol(synprg)), var: var(prg))],
  local_fns: [],
  expr: do_expr(
    [
      assignment_stmt(
        value: replace_expr(
          ptrn: var_ptrn(name: var(t), ptrn: type_ptrn(type_ref(type_symbol(type)))),
          expr: fn_call(
            name: fn_symbol(norm_type),
            params: [const_or_var(t)],
            named_params: []
          ),
          src_expr: const_or_var(prg)
        ),
        var: var(norm_prg)
      ),
      assignment_stmt(
        value: fn_call(
          name: fn_symbol(set),
          params: [
            fn_call(
              name: fn_symbol(untag),
              params: [const_or_var(norm_prg)],
              named_params: []
            )
          ],
          named_params: []
        ),
        var: var(decls)
      ),
      assignment_stmt(
        value: set_comp(
          sel_exprs: [],
          source: [
            in_clause(
              src: const_or_var(decls),
              ptrn: var_ptrn(
                name: var(d),
                ptrn: type_ptrn(type_ref(type_symbol(syntypedef)))
              )
            )
          ],
          expr: const_or_var(d)
        ),
        var: var(tdefs)
      ),
      assignment_stmt(
        value: set_comp(
          sel_exprs: [],
          source: [
            in_clause(
              src: const_or_var(decls),
              ptrn: var_ptrn(
                name: var(d),
                ptrn: type_ptrn(type_ref(type_symbol(synpartypedef)))
              )
            )
          ],
          expr: const_or_var(d)
        ),
        var: var(par_tdefs)
      ),
      assignment_stmt(
        value: set_comp(
          sel_exprs: [],
          source: [
            in_clause(
              src: const_or_var(decls),
              ptrn: var_ptrn(
                name: var(d),
                ptrn: type_ptrn(type_ref(type_symbol(synfndef)))
              )
            )
          ],
          expr: const_or_var(d)
        ),
        var: var(fndefs)
      ),
      assignment_stmt(
        value: set_comp(
          sel_exprs: [],
          source: [
            in_clause(
              src: const_or_var(decls),
              ptrn: var_ptrn(
                name: var(d),
                ptrn: type_ptrn(type_ref(type_symbol(synusingblock)))
              )
            )
          ],
          expr: const_or_var(d)
        ),
        var: var(ublocks)
      ),
      assignment_stmt(
        value: fn_call(
          name: fn_symbol(create_type_map),
          params: [const_or_var(norm_prg)],
          named_params: []
        ),
        var: var(inst_tdefs)
      ),
      assignment_stmt(
        value: fn_call(
          name: fn_symbol(union),
          params: [
            set_comp(
              sel_exprs: [],
              source: [
                in_clause(src: const_or_var(fndefs), ptrn: var_ptrn(name: var(fd)))
              ],
              expr: fn_call(
                name: fn_symbol(syn_fndef_to_fndefs),
                params: [const_or_var(fd), set_expr({})],
                named_params: []
              )
            )
          ],
          named_params: []
        ),
        var: var(desugared_fndefs)
      ),
      assignment_stmt(
        value: fn_call(
          name: fn_symbol(union),
          params: [
            set_comp(
              sel_exprs: [],
              source: [
                in_clause(src: const_or_var(ublocks), ptrn: var_ptrn(name: var(ub))),
                in_clause(
                  src: fn_call(
                    name: fn_symbol(set),
                    params: [accessor(expr: const_or_var(ub), field: object(fn_defs))],
                    named_params: []
                  ),
                  ptrn: var_ptrn(name: var(fd))
                ),
                eq_clause(
                  var: var(sgns),
                  expr: fn_call(
                    name: fn_symbol(set),
                    params: [
                      accessor(expr: const_or_var(ub), field: object(signatures))
                    ],
                    named_params: []
                  )
                )
              ],
              expr: fn_call(
                name: fn_symbol(syn_fndef_to_fndefs),
                params: [const_or_var(fd), const_or_var(sgns)],
                named_params: []
              )
            )
          ],
          named_params: []
        ),
        var: var(desugared_block_fndefs)
      ),
      return_stmt(
        tag_obj_expr(
          obj: map_expr(
            {
              (value: const_or_var(inst_tdefs), key: object(tdefs)),
              (
                value: fn_call(
                  name: op_symbol(amp),
                  params: [
                    const_or_var(desugared_fndefs),
                    const_or_var(desugared_block_fndefs)
                  ],
                  named_params: []
                ),
                key: object(fndefs)
              )
            }
          ),
          tag: object(program)
        )
      )
    ]
  ),
  res_type: type_ref(type_symbol(program))
)
