syn_fn_def(
  name: fn_symbol(extern_vars),
  params: [(type: type_ref(type_symbol(expr)), var: var(expr))],
  local_fns: [
    syn_fn_def(
      name: fn_symbol(special_cases),
      params: [(var: var(expr))],
      local_fns: [],
      expr: match_expr(
        cases: [
          case(
            expr: set_expr({const_or_var(expr)}),
            patterns: [type_ptrn(type_ref(type_symbol(var)))]
          ),
          case(
            expr: fn_call(
              name: fn_symbol(union),
              params: [
                set_comp(
                  sel_exprs: [],
                  source: [
                    map_in_clause(
                      src: accessor(expr: const_or_var(expr), field: object(named_params)),
                      value_ptrn: var_ptrn(name: var(e)),
                      key_ptrn: var_ptrn(name: var(k))
                    )
                  ],
                  expr: fn_call(
                    name: fn_symbol(extern_vars),
                    params: [const_or_var(e)],
                    named_params: []
                  )
                )
              ],
              named_params: []
            ),
            patterns: [
              tag_ptrn(obj: type_ptrn(type_any), tag: obj_ptrn(object(fn_call)))
            ]
          ),
          case(
            expr: fn_call(
              name: fn_symbol(extern_vars),
              params: [accessor(expr: const_or_var(expr), field: object(source))],
              named_params: []
            ),
            patterns: [
              tag_ptrn(obj: type_ptrn(type_any), tag: obj_ptrn(object(ex_qual)))
            ]
          ),
          case(
            expr: fn_call(
              name: fn_symbol(extern_vars),
              params: [accessor(expr: const_or_var(expr), field: object(source))],
              named_params: []
            ),
            patterns: [
              tag_ptrn(obj: type_ptrn(type_any), tag: obj_ptrn(object(set_comp)))
            ]
          ),
          case(
            expr: fn_call(
              name: fn_symbol(extern_vars),
              params: [accessor(expr: const_or_var(expr), field: object(source))],
              named_params: []
            ),
            patterns: [
              tag_ptrn(obj: type_ptrn(type_any), tag: obj_ptrn(object(map_comp)))
            ]
          ),
          case(
            expr: fn_call(
              name: fn_symbol(extern_vars),
              params: [const_or_var(ss)],
              named_params: []
            ),
            patterns: [
              tag_ptrn(
                obj: var_ptrn(name: var(ss)),
                tag: obj_ptrn(object(do_expr))
              )
            ]
          ),
          case(
            expr: fn_call(
              name: fn_symbol(extern_vars),
              params: [accessor(expr: const_or_var(expr), field: object(ptrn))],
              named_params: []
            ),
            patterns: [
              tag_ptrn(
                obj: type_ptrn(type_any),
                tag: obj_ptrn(object(select_expr))
              )
            ]
          ),
          case(
            expr: fn_call(
              name: fn_symbol(extern_vars),
              params: [accessor(expr: const_or_var(expr), field: object(ptrn))],
              named_params: []
            ),
            patterns: [
              tag_ptrn(
                obj: type_ptrn(type_any),
                tag: obj_ptrn(object(replace_expr))
              )
            ]
          ),
          case(
            expr: do_expr(
              [
                assignment_stmt(value: set_expr({}), var: var(vs)),
                for_stmt(
                  body: [
                    assignment_stmt(
                      value: fn_call(
                        name: fn_symbol(seq_union),
                        params: [
                          seq_comp(
                            var: var(p),
                            expr: fn_call(
                              name: fn_symbol(new_vars),
                              params: [const_or_var(p)],
                              named_params: []
                            ),
                            src_expr: accessor(expr: const_or_var(c), field: object(ptrns))
                          )
                        ],
                        named_params: []
                      ),
                      var: var(pvs)
                    ),
                    assignment_stmt(
                      value: fn_call(
                        name: op_symbol(amp),
                        params: [
                          const_or_var(vs),
                          fn_call(
                            name: op_symbol(minus),
                            params: [
                              fn_call(
                                name: fn_symbol(extern_vars),
                                params: [accessor(expr: const_or_var(c), field: object(expr))],
                                named_params: []
                              ),
                              const_or_var(pvs)
                            ],
                            named_params: []
                          )
                        ],
                        named_params: []
                      ),
                      var: var(vs)
                    )
                  ],
                  loops: [
                    seq_iter(
                      var: var(c),
                      values: accessor(expr: const_or_var(expr), field: object(cases))
                    )
                  ]
                ),
                return_stmt(const_or_var(vs))
              ]
            ),
            patterns: [
              tag_ptrn(
                obj: type_ptrn(type_any),
                tag: obj_ptrn(object(match_expr))
              )
            ]
          ),
          case(expr: set_expr({}), patterns: [type_ptrn(type_any)])
        ],
        exprs: [fn_par(0)]
      )
    )
  ],
  expr: do_expr(
    [
      assignment_stmt(
        value: fn_call(
          name: fn_symbol(union),
          params: [
            set_comp(
              sel_exprs: [],
              source: [
                in_clause(
                  src: fn_call(
                    name: fn_symbol(ordinary_subexprs),
                    params: [const_or_var(expr)],
                    named_params: []
                  ),
                  ptrn: var_ptrn(name: var(e))
                )
              ],
              expr: fn_call(
                name: fn_symbol(extern_vars),
                params: [const_or_var(e)],
                named_params: []
              )
            )
          ],
          named_params: []
        ),
        var: var(ord_expr_evs)
      ),
      assignment_stmt(
        value: fn_call(
          name: op_symbol(minus),
          params: [
            fn_call(
              name: fn_symbol(union),
              params: [
                set_comp(
                  sel_exprs: [],
                  source: [
                    in_clause(
                      src: fn_call(
                        name: fn_symbol(special_subexprs),
                        params: [const_or_var(expr)],
                        named_params: []
                      ),
                      ptrn: var_ptrn(name: var(e))
                    )
                  ],
                  expr: fn_call(
                    name: fn_symbol(extern_vars),
                    params: [const_or_var(e)],
                    named_params: []
                  )
                )
              ],
              named_params: []
            ),
            fn_call(
              name: fn_symbol(gen_vars),
              params: [const_or_var(expr)],
              named_params: []
            )
          ],
          named_params: []
        ),
        var: var(spec_expr_evs)
      ),
      assignment_stmt(
        value: fn_call(
          name: fn_symbol(special_cases),
          params: [const_or_var(expr)],
          named_params: []
        ),
        var: var(spec_case_evs)
      ),
      return_stmt(
        fn_call(
          name: op_symbol(amp),
          params: [
            fn_call(
              name: op_symbol(amp),
              params: [const_or_var(ord_expr_evs), const_or_var(spec_expr_evs)],
              named_params: []
            ),
            const_or_var(spec_case_evs)
          ],
          named_params: []
        )
      )
    ]
  ),
  res_type: set_type(nonempty: false, elem_type: type_ref(type_symbol(var)))
)
