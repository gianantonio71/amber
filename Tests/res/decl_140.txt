syn_fn_def(
  name: fn_symbol(tokenize),
  params: [
    (
      type: seq_type(nonempty: false, elem_type: type_ref(type_symbol(int))),
      var: var(bytes)
    )
  ],
  local_fns: [
    syn_fn_def(
      name: fn_symbol(error),
      params: [(var: var(line)), (var: var(col))],
      local_fns: [],
      expr: tag_obj_expr(
        obj: map_expr(
          {
            (value: const_or_var(line), key: object(line)),
            (value: const_or_var(col), key: object(col))
          }
        ),
        tag: object(lexer_error)
      )
    )
  ],
  expr: do_expr(
    [
      assignment_stmt(
        value: fn_call(
          name: fn_symbol(length),
          params: [const_or_var(bytes)],
          named_params: []
        ),
        var: var(len)
      ),
      assignment_stmt(value: seq_expr(head: []), var: var(tokens)),
      assignment_stmt(value: object(1), var: var(line)),
      assignment_stmt(value: object(0), var: var(line_start)),
      assignment_stmt(value: object(0), var: var(i)),
      loop_stmt(
        cond: fn_call(
          name: op_symbol(lower),
          params: [const_or_var(i), const_or_var(len)],
          named_params: []
        ),
        body: [
          assignment_stmt(
            value: fn_call(
              name: op_symbol(brackets),
              params: [const_or_var(bytes), const_or_var(i)],
              named_params: []
            ),
            var: var(ch)
          ),
          assignment_stmt(
            value: fn_call(
              name: op_symbol(plus),
              params: [const_or_var(i), object(1)],
              named_params: []
            ),
            var: var(i)
          ),
          if_stmt(
            else: [
              if_stmt(
                else: [],
                branches: [
                  (
                    cond: not(
                      fn_call(
                        name: fn_symbol(is_space),
                        params: [const_or_var(ch)],
                        named_params: []
                      )
                    ),
                    body: [
                      return_stmt(
                        fn_call(
                          name: fn_symbol(error),
                          params: [
                            const_or_var(line),
                            fn_call(
                              name: op_symbol(minus),
                              params: [const_or_var(i), const_or_var(line_start)],
                              named_params: []
                            )
                          ],
                          named_params: []
                        )
                      )
                    ]
                  )
                ]
              ),
              if_stmt(
                else: [],
                branches: [
                  (
                    cond: eq(left: const_or_var(ch), right: const_or_var(ascii_newline)),
                    body: [
                      assignment_stmt(
                        value: fn_call(
                          name: op_symbol(plus),
                          params: [const_or_var(line), object(1)],
                          named_params: []
                        ),
                        var: var(line)
                      ),
                      assignment_stmt(value: const_or_var(i), var: var(line_start))
                    ]
                  )
                ]
              )
            ],
            branches: [
              (
                cond: fn_call(
                  name: fn_symbol(is_lower),
                  params: [const_or_var(ch)],
                  named_params: []
                ),
                body: [
                  assignment_stmt(value: seq_expr(head: [const_or_var(ch)]), var: var(token)),
                  loop_stmt(
                    cond: fn_call(
                      name: op_symbol(lower),
                      params: [const_or_var(i), const_or_var(len)],
                      named_params: []
                    ),
                    body: [
                      assignment_stmt(
                        value: fn_call(
                          name: op_symbol(brackets),
                          params: [const_or_var(bytes), const_or_var(i)],
                          named_params: []
                        ),
                        var: var(ch)
                      ),
                      if_stmt(
                        else: [],
                        branches: [
                          (
                            cond: not(
                              or(
                                left: or(
                                  left: fn_call(
                                    name: fn_symbol(is_lower),
                                    params: [const_or_var(ch)],
                                    named_params: []
                                  ),
                                  right: fn_call(
                                    name: fn_symbol(is_digit),
                                    params: [const_or_var(ch)],
                                    named_params: []
                                  )
                                ),
                                right: eq(
                                  left: const_or_var(ch),
                                  right: const_or_var(ascii_underscore)
                                )
                              )
                            ),
                            body: [break_stmt]
                          )
                        ]
                      ),
                      assignment_stmt(
                        value: fn_call(
                          name: op_symbol(amp),
                          params: [const_or_var(token), seq_expr(head: [const_or_var(ch)])],
                          named_params: []
                        ),
                        var: var(token)
                      ),
                      assignment_stmt(
                        value: fn_call(
                          name: op_symbol(plus),
                          params: [const_or_var(i), object(1)],
                          named_params: []
                        ),
                        var: var(i)
                      )
                    ],
                    skip_first: false
                  ),
                  if_stmt(
                    else: [
                      assignment_stmt(
                        value: seq_expr(
                          head: [
                            fn_call(
                              name: fn_symbol(symbol),
                              params: [
                                builtin_call(
                                  name: symb,
                                  params: [
                                    fn_call(
                                      name: fn_symbol(string),
                                      params: [const_or_var(token)],
                                      named_params: []
                                    )
                                  ]
                                )
                              ],
                              named_params: []
                            )
                          ],
                          tail: const_or_var(tokens)
                        ),
                        var: var(tokens)
                      )
                    ],
                    branches: [
                      (
                        cond: and(
                          left: fn_call(
                            name: op_symbol(lower),
                            params: [const_or_var(i), const_or_var(len)],
                            named_params: []
                          ),
                          right: eq(
                            left: fn_call(
                              name: op_symbol(brackets),
                              params: [const_or_var(bytes), const_or_var(i)],
                              named_params: []
                            ),
                            right: const_or_var(ascii_column)
                          )
                        ),
                        body: [
                          assignment_stmt(
                            value: seq_expr(
                              head: [
                                fn_call(
                                  name: fn_symbol(label),
                                  params: [
                                    builtin_call(
                                      name: symb,
                                      params: [
                                        fn_call(
                                          name: fn_symbol(string),
                                          params: [const_or_var(token)],
                                          named_params: []
                                        )
                                      ]
                                    )
                                  ],
                                  named_params: []
                                )
                              ],
                              tail: const_or_var(tokens)
                            ),
                            var: var(tokens)
                          ),
                          assignment_stmt(
                            value: fn_call(
                              name: op_symbol(plus),
                              params: [const_or_var(i), object(1)],
                              named_params: []
                            ),
                            var: var(i)
                          )
                        ]
                      )
                    ]
                  )
                ]
              ),
              (
                cond: or(
                  left: eq(left: const_or_var(ch), right: const_or_var(ascii_minus)),
                  right: fn_call(
                    name: fn_symbol(is_digit),
                    params: [const_or_var(ch)],
                    named_params: []
                  )
                ),
                body: [
                  assignment_stmt(value: seq_expr(head: [const_or_var(ch)]), var: var(token)),
                  if_stmt(
                    else: [],
                    branches: [
                      (
                        cond: and(
                          left: eq(left: const_or_var(ch), right: const_or_var(ascii_minus)),
                          right: not(
                            and(
                              left: fn_call(
                                name: op_symbol(lower),
                                params: [const_or_var(i), const_or_var(len)],
                                named_params: []
                              ),
                              right: fn_call(
                                name: fn_symbol(is_digit),
                                params: [
                                  fn_call(
                                    name: op_symbol(brackets),
                                    params: [const_or_var(bytes), const_or_var(i)],
                                    named_params: []
                                  )
                                ],
                                named_params: []
                              )
                            )
                          )
                        ),
                        body: [
                          return_stmt(
                            fn_call(
                              name: fn_symbol(error),
                              params: [
                                const_or_var(line),
                                fn_call(
                                  name: op_symbol(minus),
                                  params: [const_or_var(i), const_or_var(line_start)],
                                  named_params: []
                                )
                              ],
                              named_params: []
                            )
                          )
                        ]
                      )
                    ]
                  ),
                  loop_stmt(
                    cond: and(
                      left: fn_call(
                        name: op_symbol(lower),
                        params: [const_or_var(i), const_or_var(len)],
                        named_params: []
                      ),
                      right: fn_call(
                        name: fn_symbol(is_digit),
                        params: [
                          fn_call(
                            name: op_symbol(brackets),
                            params: [const_or_var(bytes), const_or_var(i)],
                            named_params: []
                          )
                        ],
                        named_params: []
                      )
                    ),
                    body: [
                      assignment_stmt(
                        value: fn_call(
                          name: op_symbol(amp),
                          params: [
                            const_or_var(token),
                            seq_expr(
                              head: [
                                fn_call(
                                  name: op_symbol(brackets),
                                  params: [const_or_var(bytes), const_or_var(i)],
                                  named_params: []
                                )
                              ]
                            )
                          ],
                          named_params: []
                        ),
                        var: var(token)
                      ),
                      assignment_stmt(
                        value: fn_call(
                          name: op_symbol(plus),
                          params: [const_or_var(i), object(1)],
                          named_params: []
                        ),
                        var: var(i)
                      )
                    ],
                    skip_first: false
                  ),
                  assignment_stmt(
                    value: seq_expr(
                      head: [
                        fn_call(
                          name: fn_symbol(to_int),
                          params: [
                            fn_call(
                              name: fn_symbol(string),
                              params: [const_or_var(token)],
                              named_params: []
                            )
                          ],
                          named_params: []
                        )
                      ],
                      tail: const_or_var(tokens)
                    ),
                    var: var(tokens)
                  )
                ]
              ),
              (
                cond: eq(
                  left: const_or_var(ch),
                  right: const_or_var(ascii_double_quotes)
                ),
                body: [
                  assignment_stmt(value: seq_expr(head: []), var: var(rev_str)),
                  loop_stmt(
                    cond: fn_call(
                      name: op_symbol(lower),
                      params: [const_or_var(i), const_or_var(len)],
                      named_params: []
                    ),
                    body: [
                      assignment_stmt(
                        value: fn_call(
                          name: op_symbol(brackets),
                          params: [const_or_var(bytes), const_or_var(i)],
                          named_params: []
                        ),
                        var: var(ch)
                      ),
                      assignment_stmt(
                        value: fn_call(
                          name: op_symbol(plus),
                          params: [const_or_var(i), object(1)],
                          named_params: []
                        ),
                        var: var(i)
                      ),
                      if_stmt(
                        else: [
                          assignment_stmt(
                            value: seq_expr(head: [const_or_var(ch)], tail: const_or_var(rev_str)),
                            var: var(rev_str)
                          )
                        ],
                        branches: [
                          (
                            cond: eq(
                              left: const_or_var(ch),
                              right: const_or_var(ascii_double_quotes)
                            ),
                            body: [break_stmt]
                          ),
                          (
                            cond: eq(
                              left: const_or_var(ch),
                              right: const_or_var(ascii_backslash)
                            ),
                            body: [
                              if_stmt(
                                else: [],
                                branches: [
                                  (
                                    cond: not(
                                      fn_call(
                                        name: op_symbol(lower),
                                        params: [const_or_var(i), const_or_var(len)],
                                        named_params: []
                                      )
                                    ),
                                    body: [
                                      return_stmt(
                                        fn_call(
                                          name: fn_symbol(error),
                                          params: [
                                            const_or_var(line),
                                            fn_call(
                                              name: op_symbol(minus),
                                              params: [const_or_var(i), const_or_var(line_start)],
                                              named_params: []
                                            )
                                          ],
                                          named_params: []
                                        )
                                      )
                                    ]
                                  )
                                ]
                              ),
                              assignment_stmt(
                                value: fn_call(
                                  name: op_symbol(brackets),
                                  params: [const_or_var(bytes), const_or_var(i)],
                                  named_params: []
                                ),
                                var: var(ch)
                              ),
                              assignment_stmt(
                                value: fn_call(
                                  name: op_symbol(plus),
                                  params: [const_or_var(i), object(1)],
                                  named_params: []
                                ),
                                var: var(i)
                              ),
                              if_stmt(
                                else: [
                                  return_stmt(
                                    fn_call(
                                      name: fn_symbol(error),
                                      params: [
                                        const_or_var(line),
                                        fn_call(
                                          name: op_symbol(minus),
                                          params: [const_or_var(i), const_or_var(line_start)],
                                          named_params: []
                                        )
                                      ],
                                      named_params: []
                                    )
                                  )
                                ],
                                branches: [
                                  (
                                    cond: eq(left: const_or_var(ch), right: object(110)),
                                    body: [
                                      assignment_stmt(
                                        value: seq_expr(
                                          head: [const_or_var(ascii_newline)],
                                          tail: const_or_var(rev_str)
                                        ),
                                        var: var(rev_str)
                                      )
                                    ]
                                  ),
                                  (
                                    cond: or(
                                      left: eq(
                                        left: const_or_var(ch),
                                        right: const_or_var(ascii_backslash)
                                      ),
                                      right: eq(
                                        left: const_or_var(ch),
                                        right: const_or_var(ascii_double_quotes)
                                      )
                                    ),
                                    body: [
                                      assignment_stmt(
                                        value: seq_expr(head: [const_or_var(ch)], tail: const_or_var(rev_str)),
                                        var: var(rev_str)
                                      )
                                    ]
                                  )
                                ]
                              )
                            ]
                          ),
                          (
                            cond: eq(left: const_or_var(ch), right: const_or_var(ascii_newline)),
                            body: [
                              return_stmt(
                                fn_call(
                                  name: fn_symbol(error),
                                  params: [
                                    const_or_var(line),
                                    fn_call(
                                      name: op_symbol(minus),
                                      params: [const_or_var(i), const_or_var(line_start)],
                                      named_params: []
                                    )
                                  ],
                                  named_params: []
                                )
                              )
                            ]
                          )
                        ]
                      )
                    ],
                    skip_first: false
                  ),
                  assignment_stmt(
                    value: seq_expr(
                      head: [
                        fn_call(
                          name: fn_symbol(string),
                          params: [
                            fn_call(
                              name: fn_symbol(reverse),
                              params: [const_or_var(rev_str)],
                              named_params: []
                            )
                          ],
                          named_params: []
                        )
                      ],
                      tail: const_or_var(tokens)
                    ),
                    var: var(tokens)
                  )
                ]
              ),
              (
                cond: fn_call(
                  name: fn_symbol(is_symbol),
                  params: [const_or_var(ch)],
                  named_params: []
                ),
                body: [
                  assignment_stmt(
                    value: seq_expr(
                      head: [
                        fn_call(
                          name: fn_symbol(symbol_to_token),
                          params: [const_or_var(ch)],
                          named_params: []
                        )
                      ],
                      tail: const_or_var(tokens)
                    ),
                    var: var(tokens)
                  )
                ]
              )
            ]
          )
        ],
        skip_first: false
      ),
      return_stmt(
        fn_call(
          name: fn_symbol(reverse),
          params: [const_or_var(tokens)],
          named_params: []
        )
      )
    ]
  ),
  res_type: union_type(
    {
      type_ref(type_symbol(lexererror)),
      seq_type(nonempty: false, elem_type: type_ref(type_symbol(token)))
    }
  )
)
