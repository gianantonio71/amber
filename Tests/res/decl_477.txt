using_block(
  fn_defs: [
    syn_fn_def(
      name: fn_symbol(gen_code),
      params: [
        (type: type_ref(type_symbol(matchaction)), var: var(action))
      ],
      local_fns: [],
      expr: match_expr(
        cases: [
          case(
            expr: fn_call(
              name: fn_symbol(gen_iter_code),
              params: [
                accessor(expr: const_or_var(action), field: object(clause)),
                accessor(expr: const_or_var(action), field: object(action))
              ],
              named_params: []
            ),
            patterns: [
              tag_ptrn(
                obj: type_ptrn(type_any),
                tag: obj_ptrn(object(match_action))
              )
            ]
          ),
          case(
            expr: do_expr(
              [
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(lvar),
                    params: [const_or_var(next_obj_var_id)],
                    named_params: []
                  ),
                  var: var(cond_var)
                ),
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(gen_eval_info),
                    params: [
                      accessor(expr: const_or_var(action), field: object(cond)),
                      const_or_var(cond_var)
                    ],
                    named_params: [
                      syn_fn_def(
                        name: fn_symbol(next_obj_var_id),
                        params: [],
                        local_fns: [],
                        expr: fn_call(
                          name: op_symbol(plus),
                          params: [const_or_var(next_obj_var_id), object(1)],
                          named_params: []
                        )
                      )
                    ]
                  ),
                  var: var(cond_info)
                ),
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(gen_code),
                    params: [
                      accessor(expr: const_or_var(action), field: object(action))
                    ],
                    named_params: []
                  ),
                  var: var(action_code)
                ),
                return_stmt(
                  fn_call(
                    name: op_symbol(amp),
                    params: [
                      accessor(expr: const_or_var(cond_info), field: object(eval_code)),
                      seq_expr(
                        head: [
                          fn_call(
                            name: fn_symbol(check),
                            params: [
                              fn_call(
                                name: fn_symbol(is_bool),
                                params: [
                                  accessor(expr: const_or_var(cond_info), field: object(expr))
                                ],
                                named_params: []
                              )
                            ],
                            named_params: []
                          ),
                          fn_call(
                            name: fn_symbol(do_if),
                            params: [
                              fn_call(
                                name: fn_symbol(is_true),
                                params: [
                                  accessor(expr: const_or_var(cond_info), field: object(expr))
                                ],
                                named_params: []
                              ),
                              const_or_var(action_code)
                            ],
                            named_params: []
                          )
                        ]
                      )
                    ],
                    named_params: []
                  )
                )
              ]
            ),
            patterns: [
              tag_ptrn(
                obj: type_ptrn(type_any),
                tag: obj_ptrn(object(cond_match_action))
              )
            ]
          ),
          case(
            expr: seq_expr(
              head: [
                fn_call(
                  name: fn_symbol(set_var),
                  params: [
                    accessor(expr: const_or_var(action), field: object(var)),
                    const_or_var(obj_true)
                  ],
                  named_params: []
                ),
                const_or_var(exit_block)
              ]
            ),
            patterns: [
              tag_ptrn(
                obj: type_ptrn(type_any),
                tag: obj_ptrn(object(set_found_var_and_leave))
              )
            ]
          ),
          case(
            expr: do_expr(
              [
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(lvar),
                    params: [const_or_var(next_obj_var_id)],
                    named_params: []
                  ),
                  var: var(tmp_var)
                ),
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(gen_eval_info),
                    params: [
                      accessor(expr: const_or_var(action), field: object(expr)),
                      const_or_var(tmp_var)
                    ],
                    named_params: [
                      syn_fn_def(
                        name: fn_symbol(next_obj_var_id),
                        params: [],
                        local_fns: [],
                        expr: fn_call(
                          name: op_symbol(plus),
                          params: [const_or_var(next_obj_var_id), object(1)],
                          named_params: []
                        )
                      )
                    ]
                  ),
                  var: var(info)
                ),
                return_stmt(
                  fn_call(
                    name: op_symbol(amp),
                    params: [
                      accessor(expr: const_or_var(info), field: object(add_ref_eval_code)),
                      seq_expr(
                        head: [
                          fn_call(
                            name: fn_symbol(append),
                            params: [
                              accessor(expr: const_or_var(action), field: object(stream_var)),
                              accessor(expr: const_or_var(info), field: object(expr))
                            ],
                            named_params: []
                          )
                        ]
                      )
                    ],
                    named_params: []
                  )
                )
              ]
            ),
            patterns: [
              tag_ptrn(
                obj: type_ptrn(type_any),
                tag: obj_ptrn(object(eval_expr_and_add_to_set))
              )
            ]
          ),
          case(
            expr: do_expr(
              [
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(lvar),
                    params: [const_or_var(next_obj_var_id)],
                    named_params: []
                  ),
                  var: var(tmp_var)
                ),
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(gen_eval_info),
                    params: [
                      accessor(expr: const_or_var(action), field: object(key_expr)),
                      const_or_var(tmp_var)
                    ],
                    named_params: [
                      syn_fn_def(
                        name: fn_symbol(next_obj_var_id),
                        params: [],
                        local_fns: [],
                        expr: fn_call(
                          name: op_symbol(plus),
                          params: [const_or_var(next_obj_var_id), object(1)],
                          named_params: []
                        )
                      )
                    ]
                  ),
                  var: var(key_info)
                ),
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(gen_eval_info),
                    params: [
                      accessor(expr: const_or_var(action), field: object(value_expr)),
                      const_or_var(tmp_var)
                    ],
                    named_params: [
                      syn_fn_def(
                        name: fn_symbol(next_obj_var_id),
                        params: [],
                        local_fns: [],
                        expr: fn_call(
                          name: op_symbol(plus),
                          params: [const_or_var(next_obj_var_id), object(1)],
                          named_params: []
                        )
                      )
                    ]
                  ),
                  var: var(value_info)
                ),
                return_stmt(
                  fn_call(
                    name: op_symbol(amp),
                    params: [
                      fn_call(
                        name: op_symbol(amp),
                        params: [
                          fn_call(
                            name: op_symbol(amp),
                            params: [
                              accessor(
                                expr: const_or_var(key_info),
                                field: object(add_ref_eval_code)
                              ),
                              seq_expr(
                                head: [
                                  fn_call(
                                    name: fn_symbol(append),
                                    params: [
                                      accessor(expr: const_or_var(action), field: object(key_stream_var)),
                                      accessor(expr: const_or_var(key_info), field: object(expr))
                                    ],
                                    named_params: []
                                  )
                                ]
                              )
                            ],
                            named_params: []
                          ),
                          accessor(
                            expr: const_or_var(value_info),
                            field: object(add_ref_eval_code)
                          )
                        ],
                        named_params: []
                      ),
                      seq_expr(
                        head: [
                          fn_call(
                            name: fn_symbol(append),
                            params: [
                              accessor(
                                expr: const_or_var(action),
                                field: object(value_stream_var)
                              ),
                              accessor(expr: const_or_var(value_info), field: object(expr))
                            ],
                            named_params: []
                          )
                        ]
                      )
                    ],
                    named_params: []
                  )
                )
              ]
            ),
            patterns: [
              tag_ptrn(
                obj: type_ptrn(type_any),
                tag: obj_ptrn(object(eval_exprs_and_add_to_map))
              )
            ]
          )
        ],
        exprs: [fn_par(0)]
      ),
      res_type: seq_type(nonempty: false, elem_type: type_ref(type_symbol(instr)))
    ),
    syn_fn_def(
      name: fn_symbol(gen_iter_code),
      params: [
        (type: type_ref(type_symbol(clause)), var: var(clause)),
        (type: type_ref(type_symbol(matchaction)), var: var(action))
      ],
      local_fns: [],
      expr: match_expr(
        cases: [
          case(
            expr: do_expr(
              [
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(lvar),
                    params: [const_or_var(next_obj_var_id)],
                    named_params: []
                  ),
                  var: var(src_var)
                ),
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(lvar),
                    params: [
                      fn_call(
                        name: op_symbol(plus),
                        params: [const_or_var(next_obj_var_id), object(1)],
                        named_params: []
                      )
                    ],
                    named_params: []
                  ),
                  var: var(tmp_var)
                ),
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(bvar),
                    params: [const_or_var(next_bool_var_id)],
                    named_params: []
                  ),
                  var: var(res_var)
                ),
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(set_it_var),
                    params: [const_or_var(next_set_it_var_id)],
                    named_params: []
                  ),
                  var: var(it_var)
                ),
                let_stmt(
                  body: [
                    assignment_stmt(
                      value: fn_call(
                        name: fn_symbol(gen_eval_info),
                        params: [
                          accessor(expr: const_or_var(clause), field: object(src)),
                          const_or_var(src_var)
                        ],
                        named_params: []
                      ),
                      var: var(src_info)
                    ),
                    let_stmt(
                      body: [
                        assignment_stmt(
                          value: fn_call(
                            name: fn_symbol(gen_code),
                            params: [const_or_var(action)],
                            named_params: []
                          ),
                          var: var(next_step_code)
                        ),
                        assignment_stmt(
                          value: fn_call(
                            name: fn_symbol(gen_ptrn_matching_code),
                            params: [
                              accessor(expr: const_or_var(clause), field: object(ptrn)),
                              const_or_var(tmp_var),
                              const_or_var(res_var)
                            ],
                            named_params: [
                              syn_fn_def(
                                name: fn_symbol(next_obj_var_id),
                                params: [],
                                local_fns: [],
                                expr: fn_call(
                                  name: op_symbol(plus),
                                  params: [const_or_var(next_obj_var_id), object(1)],
                                  named_params: []
                                )
                              ),
                              syn_fn_def(
                                name: fn_symbol(next_bool_var_id),
                                params: [],
                                local_fns: [],
                                expr: fn_call(
                                  name: op_symbol(plus),
                                  params: [const_or_var(next_bool_var_id), object(1)],
                                  named_params: []
                                )
                              )
                            ]
                          ),
                          var: var(match_code)
                        )
                      ],
                      asgnms: [
                        syn_fn_def(
                          name: fn_symbol(next_set_it_var_id),
                          params: [],
                          local_fns: [],
                          expr: fn_call(
                            name: op_symbol(plus),
                            params: [const_or_var(next_set_it_var_id), object(1)],
                            named_params: []
                          )
                        )
                      ]
                    )
                  ],
                  asgnms: [
                    syn_fn_def(
                      name: fn_symbol(next_obj_var_id),
                      params: [],
                      local_fns: [],
                      expr: fn_call(
                        name: op_symbol(plus),
                        params: [const_or_var(next_obj_var_id), object(1)],
                        named_params: []
                      )
                    )
                  ]
                ),
                assignment_stmt(
                  value: seq_expr(
                    head: [
                      fn_call(
                        name: fn_symbol(get_iter),
                        params: [
                          const_or_var(it_var),
                          accessor(expr: const_or_var(src_info), field: object(expr))
                        ],
                        named_params: []
                      ),
                      fn_call(
                        name: fn_symbol(repeat),
                        params: [
                          fn_call(
                            name: op_symbol(amp),
                            params: [
                              fn_call(
                                name: op_symbol(amp),
                                params: [
                                  seq_expr(
                                    head: [
                                      fn_call(
                                        name: fn_symbol(break_if),
                                        params: [
                                          fn_call(
                                            name: fn_symbol(is_out_of_range),
                                            params: [const_or_var(it_var)],
                                            named_params: []
                                          )
                                        ],
                                        named_params: []
                                      ),
                                      fn_call(
                                        name: fn_symbol(set_var),
                                        params: [
                                          const_or_var(tmp_var),
                                          fn_call(
                                            name: fn_symbol(get_curr_obj),
                                            params: [const_or_var(it_var)],
                                            named_params: []
                                          )
                                        ],
                                        named_params: []
                                      )
                                    ]
                                  ),
                                  const_or_var(match_code)
                                ],
                                named_params: []
                              ),
                              seq_expr(
                                head: [
                                  fn_call(
                                    name: fn_symbol(do_if),
                                    params: [const_or_var(res_var), const_or_var(next_step_code)],
                                    named_params: []
                                  ),
                                  fn_call(
                                    name: fn_symbol(move_forward),
                                    params: [const_or_var(it_var)],
                                    named_params: []
                                  )
                                ]
                              )
                            ],
                            named_params: []
                          )
                        ],
                        named_params: []
                      )
                    ]
                  ),
                  var: var(loop_code)
                ),
                return_stmt(
                  fn_call(
                    name: op_symbol(amp),
                    params: [
                      fn_call(
                        name: op_symbol(amp),
                        params: [
                          accessor(expr: const_or_var(src_info), field: object(eval_code)),
                          const_or_var(loop_code)
                        ],
                        named_params: []
                      ),
                      accessor(expr: const_or_var(src_info), field: object(cleanup_code))
                    ],
                    named_params: []
                  )
                )
              ]
            ),
            patterns: [
              tag_ptrn(obj: type_ptrn(type_any), tag: obj_ptrn(object(in_clause)))
            ]
          ),
          case(
            expr: do_expr(
              [
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(lvar),
                    params: [const_or_var(next_obj_var_id)],
                    named_params: []
                  ),
                  var: var(src_var)
                ),
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(lvar),
                    params: [
                      fn_call(
                        name: op_symbol(plus),
                        params: [const_or_var(next_obj_var_id), object(1)],
                        named_params: []
                      )
                    ],
                    named_params: []
                  ),
                  var: var(tmp_var)
                ),
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(bvar),
                    params: [const_or_var(next_bool_var_id)],
                    named_params: []
                  ),
                  var: var(res_var)
                ),
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(set_it_var),
                    params: [const_or_var(next_set_it_var_id)],
                    named_params: []
                  ),
                  var: var(it_var)
                ),
                let_stmt(
                  body: [
                    assignment_stmt(
                      value: fn_call(
                        name: fn_symbol(gen_eval_info),
                        params: [
                          accessor(expr: const_or_var(clause), field: object(src)),
                          const_or_var(src_var)
                        ],
                        named_params: []
                      ),
                      var: var(src_info)
                    ),
                    assignment_stmt(
                      value: fn_call(
                        name: fn_symbol(gen_ptrn_matching_code),
                        params: [
                          accessor(expr: const_or_var(clause), field: object(ptrn)),
                          const_or_var(tmp_var),
                          const_or_var(res_var)
                        ],
                        named_params: [
                          syn_fn_def(
                            name: fn_symbol(next_obj_var_id),
                            params: [],
                            local_fns: [],
                            expr: fn_call(
                              name: op_symbol(plus),
                              params: [const_or_var(next_obj_var_id), object(1)],
                              named_params: []
                            )
                          ),
                          syn_fn_def(
                            name: fn_symbol(next_bool_var_id),
                            params: [],
                            local_fns: [],
                            expr: fn_call(
                              name: op_symbol(plus),
                              params: [const_or_var(next_bool_var_id), object(1)],
                              named_params: []
                            )
                          ),
                          syn_fn_def(
                            name: fn_symbol(next_set_it_var_id),
                            params: [],
                            local_fns: [],
                            expr: fn_call(
                              name: op_symbol(plus),
                              params: [const_or_var(next_set_it_var_id), object(1)],
                              named_params: []
                            )
                          )
                        ]
                      ),
                      var: var(match_code)
                    ),
                    assignment_stmt(
                      value: fn_call(
                        name: fn_symbol(gen_code),
                        params: [const_or_var(action)],
                        named_params: []
                      ),
                      var: var(next_step_code)
                    )
                  ],
                  asgnms: [
                    syn_fn_def(
                      name: fn_symbol(next_obj_var_id),
                      params: [],
                      local_fns: [],
                      expr: fn_call(
                        name: op_symbol(plus),
                        params: [const_or_var(next_obj_var_id), object(1)],
                        named_params: []
                      )
                    )
                  ]
                ),
                assignment_stmt(
                  value: seq_expr(
                    head: [
                      fn_call(
                        name: fn_symbol(get_iter),
                        params: [
                          const_or_var(it_var),
                          accessor(expr: const_or_var(src_info), field: object(expr))
                        ],
                        named_params: []
                      ),
                      fn_call(
                        name: fn_symbol(repeat),
                        params: [
                          fn_call(
                            name: op_symbol(amp),
                            params: [
                              fn_call(
                                name: op_symbol(amp),
                                params: [
                                  seq_expr(
                                    head: [
                                      fn_call(
                                        name: fn_symbol(break_if),
                                        params: [
                                          fn_call(
                                            name: fn_symbol(is_out_of_range),
                                            params: [const_or_var(it_var)],
                                            named_params: []
                                          )
                                        ],
                                        named_params: []
                                      ),
                                      fn_call(
                                        name: fn_symbol(set_var),
                                        params: [
                                          const_or_var(tmp_var),
                                          fn_call(
                                            name: fn_symbol(get_curr_obj),
                                            params: [const_or_var(it_var)],
                                            named_params: []
                                          )
                                        ],
                                        named_params: []
                                      )
                                    ]
                                  ),
                                  const_or_var(match_code)
                                ],
                                named_params: []
                              ),
                              seq_expr(
                                head: [
                                  fn_call(
                                    name: fn_symbol(do_if),
                                    params: [const_or_var(res_var), const_or_var(exit_block)],
                                    named_params: []
                                  ),
                                  fn_call(
                                    name: fn_symbol(move_forward),
                                    params: [const_or_var(it_var)],
                                    named_params: []
                                  )
                                ]
                              )
                            ],
                            named_params: []
                          )
                        ],
                        named_params: []
                      )
                    ]
                  ),
                  var: var(loop_code)
                ),
                return_stmt(
                  fn_call(
                    name: op_symbol(amp),
                    params: [
                      fn_call(
                        name: op_symbol(amp),
                        params: [
                          accessor(expr: const_or_var(src_info), field: object(eval_code)),
                          seq_expr(
                            head: [
                              fn_call(
                                name: fn_symbol(execute_block),
                                params: [
                                  fn_call(
                                    name: op_symbol(amp),
                                    params: [const_or_var(loop_code), const_or_var(next_step_code)],
                                    named_params: []
                                  )
                                ],
                                named_params: []
                              )
                            ]
                          )
                        ],
                        named_params: []
                      ),
                      accessor(expr: const_or_var(src_info), field: object(cleanup_code))
                    ],
                    named_params: []
                  )
                )
              ]
            ),
            patterns: [
              tag_ptrn(
                obj: type_ptrn(type_any),
                tag: obj_ptrn(object(not_in_clause))
              )
            ]
          ),
          case(
            expr: do_expr(
              [
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(lvar),
                    params: [const_or_var(next_obj_var_id)],
                    named_params: []
                  ),
                  var: var(src_var)
                ),
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(lvar),
                    params: [
                      fn_call(
                        name: op_symbol(plus),
                        params: [const_or_var(next_obj_var_id), object(1)],
                        named_params: []
                      )
                    ],
                    named_params: []
                  ),
                  var: var(tmp_var)
                ),
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(bvar),
                    params: [const_or_var(next_bool_var_id)],
                    named_params: []
                  ),
                  var: var(res_var)
                ),
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(map_it_var),
                    params: [const_or_var(next_map_it_var_id)],
                    named_params: []
                  ),
                  var: var(it_var)
                ),
                let_stmt(
                  body: [
                    assignment_stmt(
                      value: fn_call(
                        name: fn_symbol(gen_eval_info),
                        params: [
                          accessor(expr: const_or_var(clause), field: object(src)),
                          const_or_var(src_var)
                        ],
                        named_params: []
                      ),
                      var: var(src_info)
                    ),
                    let_stmt(
                      body: [
                        assignment_stmt(
                          value: fn_call(
                            name: fn_symbol(gen_code),
                            params: [const_or_var(action)],
                            named_params: []
                          ),
                          var: var(next_step_code)
                        ),
                        let_stmt(
                          body: [
                            assignment_stmt(
                              value: fn_call(
                                name: fn_symbol(gen_ptrn_matching_code),
                                params: [
                                  accessor(expr: const_or_var(clause), field: object(key_ptrn)),
                                  const_or_var(tmp_var),
                                  const_or_var(res_var)
                                ],
                                named_params: []
                              ),
                              var: var(key_ptrn_code)
                            ),
                            assignment_stmt(
                              value: fn_call(
                                name: fn_symbol(gen_ptrn_matching_code),
                                params: [
                                  accessor(expr: const_or_var(clause), field: object(value_ptrn)),
                                  const_or_var(tmp_var),
                                  const_or_var(res_var)
                                ],
                                named_params: []
                              ),
                              var: var(value_ptrn_code)
                            )
                          ],
                          asgnms: [
                            syn_fn_def(
                              name: fn_symbol(next_obj_var_id),
                              params: [],
                              local_fns: [],
                              expr: fn_call(
                                name: op_symbol(plus),
                                params: [const_or_var(next_obj_var_id), object(1)],
                                named_params: []
                              )
                            ),
                            syn_fn_def(
                              name: fn_symbol(next_bool_var_id),
                              params: [],
                              local_fns: [],
                              expr: fn_call(
                                name: op_symbol(plus),
                                params: [const_or_var(next_bool_var_id), object(1)],
                                named_params: []
                              )
                            )
                          ]
                        )
                      ],
                      asgnms: [
                        syn_fn_def(
                          name: fn_symbol(next_set_it_var_id),
                          params: [],
                          local_fns: [],
                          expr: fn_call(
                            name: op_symbol(plus),
                            params: [const_or_var(next_set_it_var_id), object(1)],
                            named_params: []
                          )
                        )
                      ]
                    )
                  ],
                  asgnms: [
                    syn_fn_def(
                      name: fn_symbol(next_obj_var_id),
                      params: [],
                      local_fns: [],
                      expr: fn_call(
                        name: op_symbol(plus),
                        params: [const_or_var(next_obj_var_id), object(1)],
                        named_params: []
                      )
                    )
                  ]
                ),
                assignment_stmt(
                  value: seq_expr(
                    head: [
                      fn_call(
                        name: fn_symbol(get_iter),
                        params: [
                          const_or_var(it_var),
                          accessor(expr: const_or_var(src_info), field: object(expr))
                        ],
                        named_params: []
                      ),
                      fn_call(
                        name: fn_symbol(repeat),
                        params: [
                          fn_call(
                            name: op_symbol(amp),
                            params: [
                              fn_call(
                                name: op_symbol(amp),
                                params: [
                                  seq_expr(
                                    head: [
                                      fn_call(
                                        name: fn_symbol(break_if),
                                        params: [
                                          fn_call(
                                            name: fn_symbol(is_out_of_range),
                                            params: [const_or_var(it_var)],
                                            named_params: []
                                          )
                                        ],
                                        named_params: []
                                      ),
                                      fn_call(
                                        name: fn_symbol(set_var),
                                        params: [
                                          const_or_var(tmp_var),
                                          fn_call(
                                            name: fn_symbol(get_curr_key),
                                            params: [const_or_var(it_var)],
                                            named_params: []
                                          )
                                        ],
                                        named_params: []
                                      )
                                    ]
                                  ),
                                  const_or_var(key_ptrn_code)
                                ],
                                named_params: []
                              ),
                              seq_expr(
                                head: [
                                  fn_call(
                                    name: fn_symbol(do_if),
                                    params: [
                                      const_or_var(res_var),
                                      fn_call(
                                        name: op_symbol(amp),
                                        params: [
                                          fn_call(
                                            name: op_symbol(amp),
                                            params: [
                                              seq_expr(
                                                head: [
                                                  fn_call(
                                                    name: fn_symbol(set_var),
                                                    params: [
                                                      const_or_var(tmp_var),
                                                      fn_call(
                                                        name: fn_symbol(get_curr_value),
                                                        params: [const_or_var(it_var)],
                                                        named_params: []
                                                      )
                                                    ],
                                                    named_params: []
                                                  )
                                                ]
                                              ),
                                              const_or_var(value_ptrn_code)
                                            ],
                                            named_params: []
                                          ),
                                          seq_expr(
                                            head: [
                                              fn_call(
                                                name: fn_symbol(do_if),
                                                params: [const_or_var(res_var), const_or_var(next_step_code)],
                                                named_params: []
                                              )
                                            ]
                                          )
                                        ],
                                        named_params: []
                                      )
                                    ],
                                    named_params: []
                                  ),
                                  fn_call(
                                    name: fn_symbol(move_forward),
                                    params: [const_or_var(it_var)],
                                    named_params: []
                                  )
                                ]
                              )
                            ],
                            named_params: []
                          )
                        ],
                        named_params: []
                      )
                    ]
                  ),
                  var: var(loop_code)
                ),
                return_stmt(
                  fn_call(
                    name: op_symbol(amp),
                    params: [
                      fn_call(
                        name: op_symbol(amp),
                        params: [
                          accessor(expr: const_or_var(src_info), field: object(eval_code)),
                          const_or_var(loop_code)
                        ],
                        named_params: []
                      ),
                      accessor(expr: const_or_var(src_info), field: object(cleanup_code))
                    ],
                    named_params: []
                  )
                )
              ]
            ),
            patterns: [
              tag_ptrn(
                obj: type_ptrn(type_any),
                tag: obj_ptrn(object(map_in_clause))
              )
            ]
          ),
          case(
            expr: do_expr(
              [
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(lvar),
                    params: [const_or_var(next_obj_var_id)],
                    named_params: []
                  ),
                  var: var(src_var)
                ),
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(lvar),
                    params: [
                      fn_call(
                        name: op_symbol(plus),
                        params: [const_or_var(next_obj_var_id), object(1)],
                        named_params: []
                      )
                    ],
                    named_params: []
                  ),
                  var: var(tmp_var)
                ),
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(bvar),
                    params: [const_or_var(next_bool_var_id)],
                    named_params: []
                  ),
                  var: var(res_var)
                ),
                assignment_stmt(
                  value: fn_call(
                    name: fn_symbol(map_it_var),
                    params: [const_or_var(next_map_it_var_id)],
                    named_params: []
                  ),
                  var: var(it_var)
                ),
                let_stmt(
                  body: [
                    assignment_stmt(
                      value: fn_call(
                        name: fn_symbol(gen_eval_info),
                        params: [
                          accessor(expr: const_or_var(clause), field: object(src)),
                          const_or_var(src_var)
                        ],
                        named_params: []
                      ),
                      var: var(src_info)
                    ),
                    let_stmt(
                      body: [
                        assignment_stmt(
                          value: fn_call(
                            name: fn_symbol(gen_ptrn_matching_code),
                            params: [
                              accessor(expr: const_or_var(clause), field: object(key_ptrn)),
                              const_or_var(tmp_var),
                              const_or_var(res_var)
                            ],
                            named_params: []
                          ),
                          var: var(key_ptrn_code)
                        ),
                        assignment_stmt(
                          value: fn_call(
                            name: fn_symbol(gen_ptrn_matching_code),
                            params: [
                              accessor(expr: const_or_var(clause), field: object(value_ptrn)),
                              const_or_var(tmp_var),
                              const_or_var(res_var)
                            ],
                            named_params: []
                          ),
                          var: var(value_ptrn_code)
                        )
                      ],
                      asgnms: [
                        syn_fn_def(
                          name: fn_symbol(next_obj_var_id),
                          params: [],
                          local_fns: [],
                          expr: fn_call(
                            name: op_symbol(plus),
                            params: [const_or_var(next_obj_var_id), object(1)],
                            named_params: []
                          )
                        ),
                        syn_fn_def(
                          name: fn_symbol(next_bool_var_id),
                          params: [],
                          local_fns: [],
                          expr: fn_call(
                            name: op_symbol(plus),
                            params: [const_or_var(next_bool_var_id), object(1)],
                            named_params: []
                          )
                        ),
                        syn_fn_def(
                          name: fn_symbol(next_map_it_var_id),
                          params: [],
                          local_fns: [],
                          expr: fn_call(
                            name: op_symbol(plus),
                            params: [const_or_var(next_map_it_var_id), object(1)],
                            named_params: []
                          )
                        )
                      ]
                    ),
                    assignment_stmt(
                      value: fn_call(
                        name: fn_symbol(gen_code),
                        params: [const_or_var(action)],
                        named_params: []
                      ),
                      var: var(next_step_code)
                    )
                  ],
                  asgnms: [
                    syn_fn_def(
                      name: fn_symbol(next_obj_var_id),
                      params: [],
                      local_fns: [],
                      expr: fn_call(
                        name: op_symbol(plus),
                        params: [const_or_var(next_obj_var_id), object(1)],
                        named_params: []
                      )
                    )
                  ]
                ),
                assignment_stmt(
                  value: seq_expr(
                    head: [
                      fn_call(
                        name: fn_symbol(get_iter),
                        params: [
                          const_or_var(it_var),
                          accessor(expr: const_or_var(src_info), field: object(expr))
                        ],
                        named_params: []
                      ),
                      fn_call(
                        name: fn_symbol(repeat),
                        params: [
                          fn_call(
                            name: op_symbol(amp),
                            params: [
                              fn_call(
                                name: op_symbol(amp),
                                params: [
                                  seq_expr(
                                    head: [
                                      fn_call(
                                        name: fn_symbol(break_if),
                                        params: [
                                          fn_call(
                                            name: fn_symbol(is_out_of_range),
                                            params: [const_or_var(it_var)],
                                            named_params: []
                                          )
                                        ],
                                        named_params: []
                                      ),
                                      fn_call(
                                        name: fn_symbol(set_var),
                                        params: [
                                          const_or_var(tmp_var),
                                          fn_call(
                                            name: fn_symbol(get_curr_key),
                                            params: [const_or_var(it_var)],
                                            named_params: []
                                          )
                                        ],
                                        named_params: []
                                      )
                                    ]
                                  ),
                                  const_or_var(key_ptrn_code)
                                ],
                                named_params: []
                              ),
                              seq_expr(
                                head: [
                                  fn_call(
                                    name: fn_symbol(do_if),
                                    params: [
                                      const_or_var(res_var),
                                      fn_call(
                                        name: op_symbol(amp),
                                        params: [
                                          fn_call(
                                            name: op_symbol(amp),
                                            params: [
                                              seq_expr(
                                                head: [
                                                  fn_call(
                                                    name: fn_symbol(set_var),
                                                    params: [
                                                      const_or_var(tmp_var),
                                                      fn_call(
                                                        name: fn_symbol(get_curr_value),
                                                        params: [const_or_var(it_var)],
                                                        named_params: []
                                                      )
                                                    ],
                                                    named_params: []
                                                  )
                                                ]
                                              ),
                                              const_or_var(value_ptrn_code)
                                            ],
                                            named_params: []
                                          ),
                                          seq_expr(
                                            head: [
                                              fn_call(
                                                name: fn_symbol(do_if),
                                                params: [const_or_var(res_var), const_or_var(exit_block)],
                                                named_params: []
                                              )
                                            ]
                                          )
                                        ],
                                        named_params: []
                                      )
                                    ],
                                    named_params: []
                                  ),
                                  fn_call(
                                    name: fn_symbol(move_forward),
                                    params: [const_or_var(it_var)],
                                    named_params: []
                                  )
                                ]
                              )
                            ],
                            named_params: []
                          )
                        ],
                        named_params: []
                      )
                    ]
                  ),
                  var: var(loop_code)
                ),
                return_stmt(
                  fn_call(
                    name: op_symbol(amp),
                    params: [
                      fn_call(
                        name: op_symbol(amp),
                        params: [
                          accessor(expr: const_or_var(src_info), field: object(eval_code)),
                          seq_expr(
                            head: [
                              fn_call(
                                name: fn_symbol(execute_block),
                                params: [
                                  fn_call(
                                    name: op_symbol(amp),
                                    params: [const_or_var(loop_code), const_or_var(next_step_code)],
                                    named_params: []
                                  )
                                ],
                                named_params: []
                              )
                            ]
                          )
                        ],
                        named_params: []
                      ),
                      accessor(expr: const_or_var(src_info), field: object(cleanup_code))
                    ],
                    named_params: []
                  )
                )
              ]
            ),
            patterns: [
              tag_ptrn(
                obj: type_ptrn(type_any),
                tag: obj_ptrn(object(map_not_in_clause))
              )
            ]
          ),
          case(
            expr: fn_call(
              name: op_symbol(amp),
              params: [
                fn_call(
                  name: fn_symbol(gen_iter_code),
                  params: [
                    accessor(expr: const_or_var(clause), field: object(left)),
                    const_or_var(action)
                  ],
                  named_params: []
                ),
                fn_call(
                  name: fn_symbol(gen_iter_code),
                  params: [
                    accessor(expr: const_or_var(clause), field: object(right)),
                    const_or_var(action)
                  ],
                  named_params: []
                )
              ],
              named_params: []
            ),
            patterns: [
              tag_ptrn(obj: type_ptrn(type_any), tag: obj_ptrn(object(or_clause)))
            ]
          ),
          case(
            expr: fn_call(
              name: fn_symbol(gen_iter_code),
              params: [
                accessor(expr: const_or_var(clause), field: object(left)),
                fn_call(
                  name: fn_symbol(action),
                  params: [
                    accessor(expr: const_or_var(clause), field: object(right)),
                    const_or_var(action)
                  ],
                  named_params: []
                )
              ],
              named_params: []
            ),
            patterns: [
              tag_ptrn(
                obj: type_ptrn(type_any),
                tag: obj_ptrn(object(and_clause))
              )
            ]
          )
        ],
        exprs: [fn_par(0), fn_par(1)]
      ),
      res_type: seq_type(nonempty: true, elem_type: type_ref(type_symbol(instr)))
    )
  ],
  signatures: [
    syn_sgn(
      name: fn_symbol(next_obj_var_id),
      params: [],
      res_type: type_ref(type_symbol(nat))
    ),
    syn_sgn(
      name: fn_symbol(next_int_var_id),
      params: [],
      res_type: type_ref(type_symbol(nat))
    ),
    syn_sgn(
      name: fn_symbol(next_bool_var_id),
      params: [],
      res_type: type_ref(type_symbol(nat))
    ),
    syn_sgn(
      name: fn_symbol(next_set_it_var_id),
      params: [],
      res_type: type_ref(type_symbol(nat))
    ),
    syn_sgn(
      name: fn_symbol(next_seq_it_var_id),
      params: [],
      res_type: type_ref(type_symbol(nat))
    ),
    syn_sgn(
      name: fn_symbol(next_map_it_var_id),
      params: [],
      res_type: type_ref(type_symbol(nat))
    ),
    syn_sgn(
      name: fn_symbol(next_vector_var_id),
      params: [],
      res_type: type_ref(type_symbol(nat))
    ),
    syn_sgn(
      name: fn_symbol(next_stream_var_id),
      params: [],
      res_type: type_ref(type_symbol(nat))
    )
  ]
)
